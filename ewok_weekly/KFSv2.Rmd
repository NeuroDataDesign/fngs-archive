---
title: "KFS w/ EM applied to fMRI"
author: "Tanay Agarwal & Eric Walker"
date: "November 28, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Pseudocode

#### Part 1: Simulated Data

1) Generate 10 sets of simulated data using simdata_gen.m:
    * For each set, create 100 "scans", of which 50 are unique subjects with 2 samples each
        * Do this by creating 200 timesteps for each subject scan and taking the first hundred as sample 1 and second hundred as sample 2
   simdata_gen(p='10',d='10',T='200',maxiter='20',option='1') where  
    * p is the number of output dimensions  
    * d is the number of observed dimensions  
    * T is the number of timesteps  
    * maxiter is the maximum number of iterations for EM  
    * option describes the desired A and C matrices:  
        * option = 1: sparse C, regular A
        * option = 2: smooth C, sparse A
        * option = 3: smooth & sparse C, regular A

2) For each set of generated simulated data, run parameter estimation using given scripts in PLDS package (simulation0, simulation1, etc.)

3) Run Eric's discriminability script on actual A matrices of simulated data (from step 1)

4) Run Eric's discriminability script on estimated A matrices of simulated data (from step 2)

#### Part 2: Real Data

1) For each scan in BNU1 dataset, run parameter estimation with the following inputs:
    * Y = subject scan
    * A = identity
    * C = identity
    * Q = identity
    * R = identity
    * Pi = first column of subject scan (ROI values at first time-step)
    * V = identity
    * Tolerance = 1e-6
    * Iterations = 20
    * Output = estimated [a, c, q, r, pi, v]

2) Run Eric's discriminability script on estimated A matrices of BNU1 dataset (from step 1)

## Simulation

#### Good performance

The application of discriminability to KFS parameter estimation should run well on the simulations provided in the PLDS package. The actual A matrices generated by the given scripts all have perfectly separated inter- and intra-subject distances, meaning the MNR is 1.

#### Bad performance

TBD

## Analysis

We will qualitatively assess the results by looking at the MNR and distance plots. The distances should be completely separated for the simulation data. For real data, the farther apart the distances the better.

We will quantitatively assess the results by looking at the MNR value. The MNR value should be exactly 1 for the actual A matrices and close to 1 for the estimated A matrices in the simulations. For real data, the MNR value should ideally be better than the MNR of just the vanilla time-series.

The summary plot visualization for the simulated data will be a bar graph showing the MNR values for the actual and estimated A matrices for each simulation.

## Code

#### Good Simulation Data

We can plot the actual A matrices using square heatmaps. We would expect the main diagonal of the map to be red (corresponding to higher values) because each ROI depends mostly on itself. The rest of the map would be some combination of blues.

![**Simulation 9, Subject 1 Actual A Heatmap**](sim9_sub1_A_heatmap.jpeg)

The plots above are in line with our expectations.

We expect the MNR of the actual A matrices to be 1, because they are generated as such. The distances of the actual A matrices should be perfectly separable. We expected the MNR of the estimated A matrices to be close to 1 because the KFS parameter estimation algorithm is purported to be accurate. The distances of the estimated A matrices should be almost perfectly separable.

![**Simulation 0 Actual**](sim0.jpeg)  

![**Simulation 0 Estimated**](sim0_em.jpeg) 

***

![**Simulation 1 Actual**](sim1.jpeg)  

![**Simulation 1 Estimated**](sim1_em.jpeg)  

***

![**Simulation 2 Actual**](sim2.jpeg)  

![**Simulation 2 Estimated**](sim2_em.jpeg) 

***

![**Simulation 3 Actual**](sim3.jpeg)  

![**Simulation 3 Estimated**](sim3_em.jpeg) 

***

![**Simulation 4 Actual**](sim4.jpeg)  

![**Simulation 4 Estimated**](sim4_em.jpeg) 

***

![**Simulation 5 Actual**](sim5.jpeg)  

![**Simulation 5 Estimated**](sim5_em.jpeg) 

***

![**Simulation 6 Actual**](sim6.jpeg)  

![**Simulation 6 Estimated**](sim6_em.jpeg) 

***

![**Simulation 7 Actual**](sim7.jpeg)  

![**Simulation 7 Estimated**](sim7_em.jpeg) 

***

![**Simulation 8 Actual**](sim8.jpeg)  

![**Simulation 8 Estimated**](sim8_em.jpeg) 

***

![**Simulation 9 Actual**](sim9.jpeg)  

![**Simulation 9 Estimated**](sim9_em.jpeg) 

As expected, the MNR values for the actual A matrices are 1, and the distances appear to be perfectly separable. However, the results for the estimated A matrices were not as we expected. The estimation algorithm seems to have performed poorly, as we get very poor discriminability and distance separation.

Below, we plot the summary statistics:

![ ](sim_summary.jpg)



